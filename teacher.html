<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>교사용 - 주제형 한바퀴 보드게임</title>
  <link rel="stylesheet" href="./styles.css" />
  <!-- Firebase (실시간 공유) / QR 코드 -->
  <!-- 1) firebase 라이브러리 -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>

  <!-- 2) 설정(여기서 initializeApp 실행) -->
  <script src="./firebase-config.js"></script>
  <script src="./qrcodegen.js"></script>

  <!-- 3) QR 라이브러리 -->
</head>
<body data-mode="teacher">
  <div class="container">
    <div class="header">
      <div class="title">
        <h1>주제형 한바퀴 보드게임 <span class="badge" id="modeBadge">교사용</span></h1>
      </div>

      <div class="row headerActions">
        <a class="btn small" href="./index.html">홈</a>
        <div class="tooltip" data-tip="AI 문제 자동생성은 [설정]에서 Gemini API 키를 입력하세요. (설정 안에 ‘API 키 발급받기’ 버튼이 있습니다)">
          <button class="btn small" id="openSettings">⚙️ 설정</button>
        </div>
      </div>
    </div>

          <div class="topbar guide">
        <div class="guideTitle">사용방법</div>
        <div class="guideSteps">
          1) <b>설정</b>에서 Gemini API 키 발급·저장 및 옵션 세팅
          <span class="sep">→</span>
          2) <b>주제 입력</b>
          <span class="sep">→</span>
          3) <b>문제 적용</b>(작동 확인)
          <span class="sep">→</span>
          4) <b>문제 파일 저장</b>
          <span class="sep">→</span>
          5) 학생에게 배부 (<b>학생용</b>에서 <b>문제 파일 불러오기</b>)
        </div>
      </div>

    <div class="main">
      <div class="side">
        <div class="card">
          <h2>게임 시작</h2>

          <div class="field" style="margin-bottom:10px;">
            <label>주제</label>
            <input id="topicInput" placeholder="예: 태양계와 행성" />
            <button class="btn primary" id="applyTopic">문제 적용</button>
          </div>

          <div class="hint" id="setupHint" style="display:none;">
            ⚠️ 처음 사용이라면 <button class="linkBtn" type="button" id="openSettingsInline">설정</button>에서 Gemini API 키를 저장한 뒤 ‘문제 적용’을 눌러주세요.
          </div>

                    <div class="badge" data-pack-topic>문제 파일이 없습니다.<br><span class="muted">(문제 적용 또는 불러오기)</span></div>

          <div style="height:10px"></div>

          <h2 style="margin-top:12px;">게임</h2>
          <div class="row">
            <button class="btn primary" id="startGame">게임 시작하기</button>
            <button class="btn" id="resetGame">리셋</button>
          </div>
          <p style="margin:10px 0 0; color:var(--muted); font-size:13px; line-height:1.5;">
            교사용 화면은 생성/저장이 목적입니다. 수업에서는 학생용 화면을 권장합니다.
          </p>
        </div>

        <div class="card" style="margin-top:14px;">
          <h2>저장 / 불러오기</h2>
          <div class="row">
            <button class="btn primary" id="exportPack">문제 파일 저장</button>
            <button class="btn" id="importPack">문제 파일 불러오기</button>
            <input id="importPackInput" type="file" accept=".json,application/json" style="display:none" />
          </div>
          <p style="margin:10px 0 0; color:var(--muted); font-size:13px; line-height:1.5;">
            저장된 파일(.json)을 학생용 페이지에서 불러오면 API 키 없이도 플레이 가능합니다.
          </p>
        </div>

        <div class="card" style="margin-top:14px;">
          <h2>수업 공유 (QR / 6자리 코드)</h2>
          <div class="help" style="margin-top:6px;">
            학생은 <b>학생용</b>에서 6자리 코드를 입력하거나, 아래 QR을 찍으면 바로 접속합니다.
          </div>

          <div class="row" style="align-items:center; gap:10px; margin-top:10px;">
            <div class="badge" id="roomCodeBadge" style="min-width:160px; text-align:center;">
              수업 코드: <b class="mono" id="roomCodeText">------</b>
            </div>
            <button class="btn" id="makeRoom">수업 코드 생성</button>
            <button class="btn" id="showRoomQr" disabled>QR 보기</button>
            <button class="btn" id="copyRoomLink" disabled>링크 복사</button>
          </div>
        </div>

        <div class="card" style="margin-top:14px;">
          <h2>진행상황</h2>
          <div class="log" id="log"></div>
        </div>
      </div>

      <div>
        <div class="card" style="padding:12px; margin-bottom:14px;">
          <div class="scorebox">
            <div class="badge"><span class="dot red"></span> 빨강: <b class="mono" id="scoreP1">0</b></div>
            <div class="badge"><span class="dot blue"></span> 파랑: <b class="mono" id="scoreP2">0</b></div>
            <div class="badge">⏳ <b class="mono" id="timer">07:00</b></div>

            <div class="diceWrap" style="margin-left:auto;">
              <button class="btn primary" id="rollBtn">주사위 굴리기</button>
              <div class="dice" id="dice"></div>
              <div class="badge mono" id="diceResult">주사위: 1</div>
            </div>
          </div>
        </div>

        <div class="boardWrap">
          <div class="board" id="board" aria-label="board"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- QR 모달 -->
  <div class="overlay" id="roomQrOverlay" style="display:none;">
    <div class="modal">
      <div class="modalHeader">
        <div class="modalTitle">학생용 접속 QR</div>
        <button class="btn small" id="closeRoomQr">닫기</button>
      </div>
      <div class="modalBody" style="text-align:center;">
        <canvas id="roomQrCanvas" width="220" height="220"></canvas>
        <div id="roomQrSvg" style="width:220px;height:220px;display:none;"></div>
        <img id="roomQrImg" width="220" height="220" style="display:none;" />
        <div style="margin-top:10px;">
          수업 코드: <b class="mono" id="roomQrCodeText">------</b>
        </div>
        <div class="help" style="margin-top:6px;">
          학생은 QR을 찍거나, 학생용에서 6자리 코드를 입력하면 됩니다.
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="qModal" aria-hidden="true">
    <div class="backdrop"></div>
    <div class="panel">
      <h3 id="qTitle">문제</h3>
      <p id="qText"></p>
      <div id="choiceWrap" class="choices"></div>
      <input id="aInput" placeholder="정답 입력" style="display:none" />
      <div class="row" style="justify-content:flex-end; margin-top:10px;">
        <button class="btn" id="aClose">닫기</button>
        <button class="btn primary" id="aSubmit">확인</button>
      </div>
    </div>
  </div>

  <div class="modal" id="resultModal" aria-hidden="true">
    <div class="backdrop"></div>
    <div class="panel">
      <h3 id="resultTitle">결과</h3>
      <p id="resultText"></p>
      <div class="row" style="justify-content:flex-end; margin-top:10px;">
        <button class="btn primary" id="resultClose">확인</button>
      </div>
    </div>
  </div>

  <div class="drawer" id="drawer" data-teacher-only>
    <div class="drawer__backdrop"></div>
    <div class="drawer__panel">
      <button class="btn small x" id="closeSettings">닫기</button>
      <h2>설정</h2>

      <div class="help">
        ※ GitHub Pages 같은 정적 사이트에서는 API 키를 100% 숨길 수 없습니다.<br/>
        수업 운영은 “교사가 문제 파일을 만든 뒤 저장 → 학생은 파일만 불러오기”를 권장합니다.
      </div>

      <hr/>

      <div class="stack">

        <div>
          <div class="setting-label">Gemini API 키</div>
          <input id="apiKeyInput" type="password" placeholder="AIza..." />
          <div class="row" style="margin-top:10px;">
            <button class="btn softYellow" id="getKeyBtn" type="button">API 키 발급받기(구글)</button>
          </div>
          <div class="help" style="margin-top:8px;">키는 이 브라우저(PC)에만 저장됩니다. 다른 PC에서는 다시 입력해야 합니다.</div>
        </div>

        <div class="row actions">
          <button class="btn softBlue" id="saveKey">키 저장</button>
          <button class="btn softPink" id="deleteKey">키 삭제</button>
          <button class="btn" id="testAi">AI 연결 테스트</button>
        </div>

        <div>
          <div class="setting-label">모델</div>
          <select id="geminiModel">
            <option value="gemini-2.0-flash">gemini-2.0-flash</option>
            <option value="gemini-1.5-flash">gemini-1.5-flash</option>
          </select>
        </div>


        <div>
          <div class="setting-label">문항 유형</div>
          <select id="qMode">
            <option value="mcq">4지선다</option>
            <option value="mcq_ox">4지선다+ ox퀴즈</option>
          </select>
          <div class="help">기본은 4지선다입니다. OX를 함께 생성할 수도 있습니다.</div>
        </div>

        <div>
          <label class="setting-check" style="margin-top:6px;">
            <input id="showAnswer" type="checkbox" checked />
            <span>학생 화면에서 정답/해설 공개</span>
          </label>
          <div class="help">끄면 학생은 정오답만 확인하고 정답/해설은 보지 못합니다.</div>
        </div>


        <div>
          <div class="setting-label">문제 수 <span class="setting-sub">(덱 총 문항 수)</span></div>
          <input id="deckCount" type="number" min="6" max="200" value="30" />
          <div class="help">덱 소진형: 게임 중 문제칸에 도착할 때마다 다음 문제가 출제됩니다.</div>
        </div>




        <div>
          <div class="setting-label">활동시간 <span class="setting-sub">(분)</span></div>
          <input id="activityMinutes" type="number" min="1" max="180" value="7" />
          <div class="help">게임 시작 시 타이머가 이 시간으로 설정됩니다. (학생용에도 문제 파일에 함께 저장됨)</div>
        </div>

        <div class="row">
          <button class="btn primary" id="saveAi">설정 저장</button>
        </div>
      </div>

      <hr/>
      <div class="help">
        학생용 페이지: <a href="./student.html">student.html로 이동</a><br/>
        홈: <a href="./index.html">index.html</a>
      </div>
    </div>
  </div>

  <script src="./gate.js"></script>
  <script>TeacherGate.requireAuthOnTeacherPage({homeUrl:"./index.html"});</script>
  <script src="./app.js"></script>

  <!-- QR 모달 -->
  <div class="overlay" id="qrOverlay" style="display:none;">
    <div class="modal" style="max-width:420px;">
      <div class="modalHeader">
        <div class="modalTitle">학생용 접속 QR</div>
        <button class="btn small" id="closeQr">닫기</button>
      </div>
      <div class="modalBody" style="text-align:center;">
        <div class="help" style="margin:0 0 10px;">
          학생은 QR을 찍거나, <b class="mono" id="roomCodeText2">------</b> 를 입력해 접속합니다.
        </div>
        <canvas id="qrCanvas" width="260" height="260" style="margin:0 auto;"></canvas>
        <div class="help" style="margin-top:10px; word-break:break-all;" id="roomLinkText"></div>
      </div>
    </div>
  </div>
</body>
</html>