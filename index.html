<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>주제형 한바퀴 보드게임 (2인 대결)</title>
  <link rel="stylesheet" href="./styles.css" />
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <div class="brand__title">주제형 한바퀴 보드게임</div>
      <div class="brand__sub">주제 입력 → 말판 문제 교체 · 2인 턴제 · 저장/복원</div>
    </div>
    <div class="topbar__actions">
      <button id="openSettings" class="iconbtn" title="설정">
        <span aria-hidden="true">⚙️</span>
      </button>
    </div>
  </header>

  <main class="page">
    <section class="panel">
      <div class="card">
        <div class="card__title">게임 시작</div>
        <div class="stack">
          <label class="label">주제</label>
          <div class="row">
            <input id="topicInput" class="input" placeholder="예: 분수, 지구와 달, 조선시대, 안전교육…" />
            <button id="applyTopic" class="btn">문제 적용</button>
          </div>
          <div class="row row--wrap">
            <div class="pill" id="cellsStatus">문제: 기본 세트</div>
            <div class="pill" id="aiStatus">AI: 미사용</div>
          </div>

          <div class="divider"></div>

          <label class="label">게임</label>
          <div class="row">
            <button id="startGame" class="btn btn--primary">게임 시작하기</button>
            <button id="resetGame" class="btn btn--ghost">리셋</button>
          </div>
          <div class="hint">
            주제 적용 후 게임을 시작하면, 말판 문제는 해당 주제로 바뀐 상태로 진행됩니다.
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card__title">저장/복원</div>
        <div class="stack">
          <div class="row row--wrap">
            <label class="check"><input id="autoSave" type="checkbox" /> 자동 저장</label>
            <button id="exportJson" class="btn">데이터 내보내기(JSON)</button>
            <label class="btn filebtn">
              JSON 가져오기
              <input id="importJson" type="file" accept="application/json" />
            </label>
          </div>
          <div class="row">
            <button id="clearData" class="btn btn--danger">모든 데이터 삭제</button>
          </div>
          <div class="hint">
            저장 항목: 주제/모델/문제 목록(cells) + 마지막 갱신시각. 각 사용자 브라우저에 개별 저장됩니다.
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card__title">로그</div>
        <div id="log" class="log"></div>
      </div>
    </section>

    <section class="stage">
      <div class="stage__top">
        <div class="score">
          <div class="score__title">점수판 (합산)</div>
          <div id="scoreP1" class="score__line">🔴 빨강: 0</div>
          <div id="scoreP2" class="score__line">🔵 파랑: 0</div>
          <div id="timer" class="timer">⏳ 07:00</div>
        </div>

        <div class="controls">
          <button id="rollBtn" class="btn btn--primary" disabled>주사위 굴리기</button>
          <div class="diceArea">
            <div id="dice" class="dice"></div>
            <div id="diceResult" class="diceResult"></div>
          </div>
        </div>
      </div>

      <div id="board" class="board">
        <div id="rails" class="rails" aria-hidden="true">
          <span class="t"></span><span class="r"></span><span class="b"></span><span class="l"></span>
        </div>
        <div id="boardCenter" class="boardCenter" aria-hidden="true">
          <div class="centerText">
            <div class="centerText__title">주제형 문제 모드</div>
            <div class="centerText__sub">설정(⚙️)에서 AI 생성 또는 오프라인 템플릿을 선택할 수 있습니다.</div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Question Modal -->
  <div id="qModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="questionText">
    <div class="modalBox">
      <div id="questionLabel" class="modalLabel"></div>
      <div id="questionText" class="modalTitle"></div>
      <img id="questionImg" class="modalImg" alt="문제 이미지" />
      <input id="answerInput" class="input" placeholder="정답 입력" />
      <div class="modalActions">
        <button id="submitAnswer" class="btn btn--primary">확인</button>
        <button id="closeQ" class="btn btn--ghost">닫기</button>
      </div>
    </div>
  </div>

  <!-- Result Modal -->
  <div id="resultModal" class="modal" role="dialog" aria-modal="true">
    <div class="modalBox">
      <div id="resultContent" class="result"></div>
    </div>
  </div>

  <!-- End Modal -->
  <div id="endModal" class="modal" role="dialog" aria-modal="true">
    <div class="modalBox">
      <div id="endContent" class="result"></div>
      <div class="modalActions">
        <button id="closeEnd" class="btn btn--primary">닫기</button>
      </div>
    </div>
  </div>

  <!-- Settings Drawer -->
  <div id="settingsOverlay" class="overlay" aria-hidden="true">
    <aside id="settings" class="drawer" role="dialog" aria-modal="true" aria-label="설정">
      <div class="drawer__head">
        <div>
          <div class="drawer__title">설정</div>
          <div class="drawer__sub">AI 설정 · 데이터 관리 · 사용 방법</div>
        </div>
        <button id="closeSettings" class="iconbtn" title="닫기">✕</button>
      </div>

      <div class="drawer__body">
        <div class="card card--flat">
          <div class="card__title">AI 설정</div>
          <div class="stack">
            <div class="row row--wrap">
              <div class="pill" id="apiKeyBadge">API 키 상태: 미설정</div>
              <div class="pill" id="proxyBadge">프록시: 미설정</div>
            </div>

            <label class="label">생성 방식</label>
            <select id="genMode" class="input">
              <option value="offline">오프라인(템플릿)</option>
              <option value="gemini_proxy">Gemini (프록시/권장)</option>
              <option value="gemini_browser">Gemini (브라우저 직접 호출/키 노출 위험)</option>
            </select>

            <label class="label">모델</label>
            <select id="modelSelect" class="input">
              <option value="gemini-2.0-flash">gemini-2.0-flash</option>
              <option value="gemini-1.5-flash">gemini-1.5-flash</option>
              <option value="gemini-2.5-flash">gemini-2.5-flash</option>
            </select>

            <label class="label">문제 수(말판 문제 칸 수와 자동 맞춤)</label>
            <input id="questionCount" class="input" type="number" min="10" max="80" step="1" value="24" />
            <div class="hint">실제 사용 시, 말판의 ‘문제 칸’ 개수에 맞춰 자동으로 조정됩니다.</div>

            <div class="divider"></div>

            <label class="label">Gemini API 키 (로컬 저장)</label>
            <input id="apiKeyInput" class="input" type="password" placeholder="(브라우저 직접 호출 모드에서만 필요)" />
            <div class="row">
              <button id="saveKey" class="btn">키 저장</button>
              <button id="deleteKey" class="btn btn--danger">키 삭제</button>
            </div>
            <div class="hint">
              GitHub Pages 같은 정적 사이트는 키를 서버에서 숨길 수 없습니다. 키 노출을 막으려면 아래의 “프록시 URL” 방식(Cloudflare Worker)을 사용하세요.
            </div>

            <label class="label">프록시 URL (권장)</label>
            <input id="proxyUrl" class="input" placeholder="예: https://your-worker.yourname.workers.dev" />
            <div class="row">
              <button id="saveProxy" class="btn">프록시 저장</button>
              <button id="deleteProxy" class="btn btn--danger">프록시 삭제</button>
            </div>
            <div class="hint">
              프록시는 서버(Worker)에만 키를 저장하고, 브라우저에는 키를 두지 않습니다. 무료로 구성 가능.
            </div>

            <div class="row">
              <button id="testAi" class="btn btn--ghost">AI 연결 테스트</button>
            </div>
          </div>
        </div>

        <div class="card card--flat">
          <div class="card__title">사용 방법</div>
          <ol class="ol">
            <li>주제 입력 → <b>문제 적용</b> → 말판 문제가 교체됩니다.</li>
            <li><b>게임 시작하기</b> 후, 2명이 번갈아 <b>주사위 굴리기</b>.</li>
            <li>문제는 정답(대소문자 무시/복수정답 가능: |로 구분) 기준으로 채점합니다.</li>
            <li><b>저장/복원</b>: 자동 저장 또는 JSON 내보내기/가져오기.</li>
          </ol>
          <details class="details">
            <summary>Gemini API 키 “도메인 제한(HTTP referrer)” 안내</summary>
            <div class="hint">
              브라우저 직접 호출을 사용할 경우, Google AI Studio/Cloud Console에서 API 키에 <b>HTTP referrers</b> 제한을 걸어
              “내 GitHub Pages 도메인에서만” 동작하도록 설정하면 악용 위험을 줄일 수 있습니다.
            </div>
          </details>
        </div>

        <div class="card card--flat">
          <div class="card__title">데이터 관리</div>
          <div class="stack">
            <div class="hint">아래는 앱이 localStorage에 저장하는 항목입니다.</div>
            <pre id="storagePreview" class="code"></pre>
          </div>
        </div>
      </div>
    </aside>
  </div>

  <script src="./app.js"></script>
</body>
</html>
